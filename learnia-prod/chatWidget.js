import{getOrGenerateSessionId,sendMessageToBotStream,updateHistoryOnBackend}from"./apiService.js";import{addMessage,initWidget,createStreamingMessageElement,updateMessageElement,finalizeMessageElement}from"./domUtils.js";const userName=window.sessionStorage.getItem("userName")||"Anónimo";document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("chatbot-toggle"),t=document.getElementById("chatbot-window"),s=document.getElementById("close-chat"),n=document.getElementById("minimize-chat"),a=document.getElementById("chat-messages"),i=document.getElementById("user-input"),o=document.getElementById("send-button"),r=document.getElementById("suggestions-toggle"),c=document.getElementById("quick-suggestions"),d=document.querySelectorAll(".suggestion-btn"),l=document.getElementById("reset-session");sessionStorage.removeItem("chatbotSessionId");let m=!1,u=!1,g=!1,p=[];const v="https://server-funcs.azurewebsites.net/api/webhook?";performance.now();let h=getOrGenerateSessionId();performance.now();const f=["Hola, soy MentIA, tu mentor virtual en Learnia Academy. ¡Bienvenido a tu experiencia de aprendizaje! ¿Tienes dudas sobre el contenido, las actividades o la plataforma? Estoy para ti.","Hola, soy MentIA, tu mentor virtual en Learnia Academy. ¿Listo para aprender? Puedo ayudarte con preguntas sobre tus cursos, evaluaciones o cómo avanzar más rápido.","Hola, soy MentIA, tu mentor virtual en Learnia Academy. ¿Tienes preguntas sobre tu progreso, evaluaciones o próximas fechas clave? Pregúntame lo que quieras."],y=f[Math.floor(Math.random()*f.length)],L={apiEndpoint:v,initialMessage:y};async function E(){const e=i.value.trim();if(""===e||u)return;addMessage(e,"user",a),i.value="",g&&c&&(c.classList.add("hidden"),g=!1,r.innerHTML='<i class="fas fa-lightbulb mr-1"></i> Sugerencias'),u=!0;const t=`msg-${Date.now()}`,s=createStreamingMessageElement(t);a.appendChild(s),a.scrollTop=a.scrollHeight;let n="";sendMessageToBotStream(e,h,v,p,e=>{n+=e,updateMessageElement(t,e),a.scrollTop=a.scrollHeight},()=>{finalizeMessageElement(t,n),p.push({role:"user",content:e}),p.push({role:"assistant",content:n}),updateHistoryOnBackend(h,p),u=!1,a.scrollTop=a.scrollHeight},e=>{updateMessageElement(t,"❌ Error en la conexión"),console.error("Streaming error:",e),u=!1,a.scrollTop=a.scrollHeight},userName)}initWidget(L),e.addEventListener("click",function(){m=!m,m?(t.classList.remove("hidden"),e.innerHTML='<i class="fas fa-times text-2xl"></i>',e.classList.remove("bg-primary-600","hover:bg-primary-700"),e.classList.add("bg-secondary-600","hover:bg-secondary-700"),setTimeout(()=>i.focus(),300)):(t.classList.add("hidden"),e.innerHTML='<i class="fas fa-comment-dots text-2xl"></i>',e.classList.remove("bg-secondary-600","hover:bg-secondary-700"),e.classList.add("bg-primary-600","hover:bg-primary-700"))}),s&&s.addEventListener("click",function(){alert("Función de cerrar implementada en la versión completa")}),n&&n.addEventListener("click",function(){alert("Función de minimizar implementada en la versión completa")}),l&&l.addEventListener("click",function(){sessionStorage.removeItem("chatbotSessionId"),h=getOrGenerateSessionId(),p=[],a&&(a.innerHTML=""),addMessage(L.initialMessage,"assistant",a),m=!0,t.classList.remove("hidden"),e.innerHTML='<i class="fas fa-times text-2xl"></i>',e.classList.remove("bg-primary-600","hover:bg-primary-700"),e.classList.add("bg-secondary-600","hover:bg-secondary-700"),setTimeout(()=>i.focus(),300)}),r&&r.addEventListener("click",function(){g=!g,g?(c.classList.remove("hidden"),r.innerHTML='<i class="fas fa-chevron-up mr-1"></i> Ocultar'):(c.classList.add("hidden"),r.innerHTML='<i class="fas fa-lightbulb mr-1"></i> Sugerencias')}),d.length>0&&d.forEach(e=>{e.addEventListener("click",function(){i&&(i.value=this.textContent.trim(),i.focus())})}),o&&o.addEventListener("click",E),i&&i.addEventListener("keypress",function(e){"Enter"===e.key&&E()})});