import{getOrGenerateSessionId,sendMessageToBotStream,updateHistoryOnBackend}from"./apiService.js";import{addMessage,showTypingIndicator,hideTypingIndicator,initWidget,createStreamingMessageElement,updateMessageElement,finalizeMessageElement}from"./domUtils.js";document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("chatbot-toggle"),t=document.getElementById("chatbot-window"),n=document.getElementById("close-chat"),s=document.getElementById("minimize-chat"),a=document.getElementById("chat-messages"),i=document.getElementById("user-input"),o=document.getElementById("send-button"),r=document.getElementById("typing-indicator"),d=document.getElementById("suggestions-toggle"),c=document.getElementById("quick-suggestions"),l=document.querySelectorAll(".suggestion-btn"),m=document.getElementById("reset-session");sessionStorage.removeItem("chatbotSessionId");let u=!1,g=!1,p=!1,h=[];const y="https://server-funcs.azurewebsites.net/api/webhook?",v=performance.now(),f=getOrGenerateSessionId(),E=performance.now();console.log(`getOrGenerateSessionId runtime: ${E-v} ms`);const L=["Hola, soy MentIA, tu mentor virtual en Learnia Academy. ¡Bienvenido a tu experiencia de aprendizaje! ¿Tienes dudas sobre el contenido, las actividades o la plataforma? Estoy para ti.","Hola, soy MentIA, tu mentor virtual en Learnia Academy. ¿Listo para aprender? Puedo ayudarte con preguntas sobre tus cursos, evaluaciones o cómo avanzar más rápido.","Hola, soy MentIA, tu mentor virtual en Learnia Academy. ¿Tienes preguntas sobre tu progreso, evaluaciones o próximas fechas clave? Pregúntame lo que quieras."],I=L[Math.floor(Math.random()*L.length)];async function b(){const e=i.value.trim();if(""===e||g)return;addMessage(e,"user",a),i.value="",p&&c&&(c.classList.add("hidden"),p=!1,d.innerHTML='<i class="fas fa-lightbulb mr-1"></i> Sugerencias'),g=!0,showTypingIndicator(r,a);const t=`msg-${Date.now()}`,n=createStreamingMessageElement(t);a.appendChild(n),a.scrollTop=a.scrollHeight;let s="";sendMessageToBotStream(e,f,y,h,e=>{s+=e,updateMessageElement(t,e),a.scrollTop=a.scrollHeight},()=>{finalizeMessageElement(t,s),h.push({role:"user",content:e}),h.push({role:"assistant",content:s}),updateHistoryOnBackend(f,h),hideTypingIndicator(r),g=!1,a.scrollTop=a.scrollHeight},e=>{updateMessageElement(t,"❌ Error en la conexión"),console.error("Streaming error:",e),hideTypingIndicator(r),g=!1,a.scrollTop=a.scrollHeight})}initWidget({apiEndpoint:y,initialMessage:I}),e.addEventListener("click",function(){u=!u,u?(t.classList.remove("hidden"),e.innerHTML='<i class="fas fa-times text-2xl"></i>',e.classList.remove("bg-primary-600","hover:bg-primary-700"),e.classList.add("bg-secondary-600","hover:bg-secondary-700"),setTimeout(()=>i.focus(),300)):(t.classList.add("hidden"),e.innerHTML='<i class="fas fa-comment-dots text-2xl"></i>',e.classList.remove("bg-secondary-600","hover:bg-secondary-700"),e.classList.add("bg-primary-600","hover:bg-primary-700"))}),n&&n.addEventListener("click",function(){alert("Función de cerrar implementada en la versión completa")}),s&&s.addEventListener("click",function(){alert("Función de minimizar implementada en la versión completa")}),m&&m.addEventListener("click",function(){sessionStorage.removeItem("chatbotSessionId"),location.reload()}),d&&d.addEventListener("click",function(){p=!p,p?(c.classList.remove("hidden"),d.innerHTML='<i class="fas fa-chevron-up mr-1"></i> Ocultar'):(c.classList.add("hidden"),d.innerHTML='<i class="fas fa-lightbulb mr-1"></i> Sugerencias')}),l.length>0&&l.forEach(e=>{e.addEventListener("click",function(){i&&(i.value=this.textContent.trim(),i.focus())})}),o&&o.addEventListener("click",b),i&&i.addEventListener("keypress",function(e){"Enter"===e.key&&b()})});